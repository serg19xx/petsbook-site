#!/bin/bash

TAG_PREFIX="backup-"

# –°—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ —Ç–µ–≥–∏
all_tags=$(git tag)

# –§–∏–ª—å—Ç—Ä—É–µ–º –Ω—É–∂–Ω—ã–µ —Ç–µ–≥–∏
filtered_tags=()
while IFS= read -r tag; do
  if [[ "$tag" == "$TAG_PREFIX"* ]]; then
    filtered_tags+=("$tag")
  fi
done <<< "$all_tags"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è
if [[ ${#filtered_tags[@]} -eq 0 ]]; then
  echo "‚ùå –ù–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ç–µ–≥–∞ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º '$TAG_PREFIX'."
  exit 1
fi

# –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏ (–∞–ª—Ñ–∞–≤–∏—Ç–Ω–æ = –ø–æ –¥–∞—Ç–µ –≤ –≤–∞—à–µ–º —Ñ–æ—Ä–º–∞—Ç–µ)
IFS=$'\n' sorted=($(printf "%s\n" "${filtered_tags[@]}" | sort -r))
unset IFS

latest_tag="${sorted[0]}"
echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø: $latest_tag"

# –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
if [[ -n $(git status --porcelain) ]]; then
  echo "‚ö†Ô∏è  –ï—Å—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –û–Ω–∏ –±—É–¥—É—Ç –£–î–ê–õ–ï–ù–´!"
fi

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
read -p "–¢–æ—á–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ç—É –≤–µ—Ä—Å–∏—é? (y/n): " confirm
if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
  echo "‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞."
  exit 0
fi

# –û—Ç–∫–∞—Ç
git reset --hard "$latest_tag"

echo "‚úÖ –ì–æ—Ç–æ–≤–æ. –í—ã –Ω–∞ –≤–µ—Ä—Å–∏–∏: $latest_tag"