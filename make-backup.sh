#!/bin/bash

# === –ù–ê–°–¢–†–û–ô–ö–ò ===
MAX_BACKUPS=5          # –°–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –±—ç–∫–∞–ø–æ–≤ —Ö—Ä–∞–Ω–∏—Ç—å
TAG_PREFIX="backup-"   # –ü—Ä–µ—Ñ–∏–∫—Å —Ç–µ–≥–∞
REMOTE_NAME="origin"   # –ù–∞–∑–≤–∞–Ω–∏–µ —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

# === –ü–†–û–í–ï–†–ö–ê –ù–ï–ó–ê–ö–û–ú–ú–ò–ß–ï–ù–ù–´–• –ò–ó–ú–ï–ù–ï–ù–ò–ô ===
if [[ -n $(git status --porcelain) ]]; then
  echo "‚ö†Ô∏è  –£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è."
  read -p "–•–æ—Ç–∏—Ç–µ –∑–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –∏—Ö –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –±—ç–∫–∞–ø–∞? (y/n): " answer

  if [[ "$answer" == "y" || "$answer" == "Y" ]]; then
    read -p "–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∫–æ–º–º–∏—Ç—É: " commit_msg
    git add .
    git commit -m "$commit_msg"
    echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã."
  else
    echo "‚ùå –ë—ç–∫–∞–ø –ø—Ä–µ—Ä–≤–∞–Ω: –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —á–∏—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–ª–∏ –∫–æ–º–º–∏—Ç."
    exit 1
  fi
fi

# === –°–û–ó–î–ê–ù–ò–ï –¢–ï–ì–ê ===
timestamp=$(date +"%Y%m%d-%H%M")
tag_name="${TAG_PREFIX}${timestamp}"

read -p "–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –±—ç–∫–∞–ø–∞ (—Ç–µ–≥–∞): " tag_msg

git tag -a "$tag_name" -m "$tag_msg"
git push "$REMOTE_NAME" "$tag_name"

echo "‚úÖ –ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∫–∞–∫ —Ç–µ–≥: $tag_name"

# === –û–ß–ò–°–¢–ö–ê –°–¢–ê–†–´–• –¢–ï–ì–û–í ===
echo "üßπ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤..."

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–µ–≥–æ–≤ —Å –Ω—É–∂–Ω—ã–º –ø—Ä–µ—Ñ–∏–∫—Å–æ–º, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –¥–∞—Ç–µ
old_tags=$(git tag --sort=-creatordate | grep "^$TAG_PREFIX" | tail -n +$((MAX_BACKUPS + 1)))

if [[ -n "$old_tags" ]]; then
  echo "–£–¥–∞–ª—è—é—Ç—Å—è —Å—Ç–∞—Ä—ã–µ —Ç–µ–≥–∏:"
  echo "$old_tags"

  # –£–¥–∞–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –∏ –Ω–∞ —É–¥–∞–ª—ë–Ω–∫–µ
  for tag in $old_tags; do
    git tag -d "$tag"
    git push "$REMOTE_NAME" --delete "$tag"
  done

  echo "‚úÖ –£–¥–∞–ª–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ —Ç–µ–≥–∏, –æ—Å—Ç–∞–≤–ª–µ–Ω–æ $MAX_BACKUPS –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –±—ç–∫–∞–ø–æ–≤."
else
  echo "üëå –ù–µ—Ç —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è."
fi